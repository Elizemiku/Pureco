---
title: "Relatório técnico de dados do PURECO"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
author: "Elizabeth Borgognoni Souto"
output: pdf_document
---

### Trabalhando com os dados: Descrição dos dados, comentários sobre formas de padronização e sobre as  planilhas coletadas pelo aplicativo.

<p style="font-size:18px;color: blue;"> Explicação das variavéis da planilha de faxinas: </p>

<!-- colocar na ordem que esta a tabela -->
- Tabela **Faxinas**: período de 2018 a 2021. 
  - | **Data**: Data marcada da faxina.
  - | **Colaboradora**: Nome da colaboradora que realizou a faxina.
  - | **Valor**: Valor cobrado da faxina em reais.
  - | **Cliente**: Nome do cliente que pediu a faxina.
  - | **Endereço**: Endereço do cliente que pediu a faxina.
  - | **Ocorreu?**: Representa se a faxina marcada na data ocorreu. 
  - | **Feedback Colhido?**: Representa se o feedback do cliente foi anotado.
  - | **Onde foi Colhido?**: Local em que o feedback foi anotado. 
  - | **Nota feedback cliente**: Nota que o cliente deu para a faxina.
  - | **Nota feedback mulher**: Nota que a mulher deu para o seu cliente. 
  - | **Comentários gerais**: Comentários gerais sobre os serviços realizados.
  - | **Remarcou** : Representa se a faxina foi remarcada. 
  - | **Tipo**: Representa se o cliente já havia pedido antes uma faxina ou se um pedido de
    | faxina novo.
  - | **Região**: Região no qual foi realizada a faxina.
  - | **Feedback cliente**: Comentários dos clientes sobre a faxina.
  - | **CEP** : Cep do endereço no qual foi realiza a faxina.
  - | **Feedback mulher**: Comentários das colaboradoras sobre a faxina.
  
 
- Tabela **Disponibilidade**: período de 2018 a 2020.
  - | **Mulher** : Nome da colaboradora que tem disponibilidade para realizar a faxina.
  - | **Disponibilidade** : Disponibilidade do número de faxinas que pode realizar por dia. 
  - | **Data** : Data disponível para a faxina. 
  
<p style="font-size:18px;color: blue;"> Mudanças na etapa de limpeza dos dados: </p>

- | Usou-se o comando join para juntar três planilhas do período de 2018 a 2019 e de 2019 a 2020 em apenas uma.
- | Números da coluna **Valor**: removeu-se os **R$** da frente dos números.
- | Nome dos endereços: Modificou-se para quando for uma Rua começar com apenas *Rua* e quando for Avenida começar com *Avenida*.
- | Valores como **2,5 ~ 3,0** foram truncados para o máximo **3,0**.
- | Nome das colunas **Feedback cliente** e **Feedback mulher** da planilha mais antiga  modificados para **Nota feedback Cliente** e **Nota feedback Mulher**.
- | Removeu-se todas as colunas vazias ou que continham números sem sentido. 
- | Os valores: 0 ou 1, true ou false, que se transformaram em Sim ou Não.
    
<p style="font-size:18px;color: blue;">Ideias de análises e gráficos: </p>   

- | Quantidade de faxinas totais por Dia da semana - OK 
- | Quantidade de faxinas totais por Tipo: o gráfico mostra se há mais clientes novos requisitando faxinas ou se a maioria ainda são os clientes mais antigos - OK 
- | Quantidade faxinas totais por mulher - OK
- | Quantidade de faxinas totais por colaboradora e dia da semana - OK
- | Porcentagem de faxinas que não ocorreram, que foram remarcadas ou não - OK
- | Boxplot da media de preços das faxinas realizadas por mulher - OK
- | Preço de faxinas por colaboradora - OK
- | Porcentagem de faxinas que não ocorreram, que foram remarcadas ou não - OK
- | Gráfico pra analisar quais as notas de feedback do cliente e das colaboradoras - OK
- | Gráfico do valor ganho com as faxinas por mês para cada faxineira - OK

```{r echo=FALSE}
#opções dos chunks 
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
# carregando pacotes para manipulação das planilhas
library("stringr")
library("tidyverse")
library("readxl")
library("rebus")
library("knitr")
library("kableExtra")

# pacote para visualização de tabelas Data table (DT)
# library("DT")
# opções para DT tabelas, caso fosse desejavel visualizar dinamicamente as tabelas 
# options(DT.options = list(
#   initComplete = JS(
#     "function(settings, json) {",
#     "$(this.api().table().header()).css({'background-color': '#1d80e2  ', 
#     'color': 'white'});",
#     "}"),
#   columnDefs = list(list(className = 'dt-center', targets = 5)),
#   pageLength = 5,
#   language = list(search = 'Busca:'),
#   lengthMenu = c(5, 10, 15, 20))
#   
```

<!-- #### Planilha de dados das faxinas do Pureco de 2018 a 2019 -->
```{r}
# a funcao read_xlsx le os dados de uma planilha do excel
# skip = 1 pula uma linha
# col_names = TRUE mostra o nome das colunas
# em col_types podemos dizer o tipo da variável para cada coluna
# range é quais as colunas e linhas selecionadas da planilha do excel 

faxinas201819 <-
  read_xlsx("dados/[2018-2019]GerenciamentodoAplicativo.xlsx",
    skip = 1,
    col_names = TRUE,
    col_types = c(
      "guess",
      "text",
      "numeric",
      "text",
      "text",
      "logical",
      "logical",
      "text",
      "guess",
      "numeric",
      "text"
    ),
    range = "A2:K432"
  )

```

<!-- #### Limpeza dos dados da planinha de 2018 a 2019 -->

```{r}
# modificando o "2,5 ~ 3,0" valor para apenas um valor numerico
faxinas201819$`Feedback cliente`[faxinas201819$`Feedback cliente` == "2,5 ~ 3,0"] <- "3.0"

# transformando `Ocorreu?` e `Feedback Colhido?` para variáveis do tipo caracter
# em cliente e endereço tudo que encontramos como -, --, //, ccc ou rua transformamos para NA(valores faltantes)
# renomeamos a coluna Mulher para Colaborada e a coluna ...11 é de comentários gerais nesta planilha
faxinas201819 <- faxinas201819 %>%
  mutate(`Ocorreu?` = as.character(`Ocorreu?`),
         `Feedback Colhido?` = as.character(`Feedback Colhido?`)) %>%
  mutate_at(c("Cliente", "Endereço"),
            funs(ifelse(. == "-" |. == "--" | . == "/" | . == "ccc" | . == "rua", NA, .))) %>%
  rename(Colaboradora = Mulher,
         "Comentários gerais"= "...11") 

```

```{r}
# passando todos os valores logicos true e false para sim e nao 
faxinas201819[faxinas201819 == TRUE] <- "Sim"
faxinas201819[faxinas201819 == FALSE] <- "Não"

# mudando as datas para o formato brasileiro
faxinas201819$Data <- format(faxinas201819$Data, "%d/%m/%Y")

# nesta planilha as notas de feedback estao em feedback cliente 
faxinas201819$`Feedback cliente` <- as.numeric(faxinas201819$`Feedback cliente`)

```

```{r}

# usando comandos de regex para arrumar colunas que contem frases
# str_trim tira os espaços excessivos entre as palavras
# str_to_title começa as palavras com letra maiscula
# str_replace_all troca a palavra de acordo com o regex passado
faxinas201819$Cliente <- str_trim(str_to_title(faxinas201819$Cliente))
faxinas201819$`Comentários gerais` <- str_trim(faxinas201819$`Comentários gerais`)
faxinas201819$Endereço <-  str_replace_all(faxinas201819$Endereço, "R\\.", "Rua ")
faxinas201819$Endereço <- str_replace_all(faxinas201819$Endereço, "R ", "Rua ")
faxinas201819$Endereço <- str_replace_all(faxinas201819$Endereço, "^Av.", "Avenida ")
faxinas201819$Endereço <- str_trim(str_to_title(faxinas201819$Endereço))

# nao consegui fazer encontrar um caractere antes de qualquer frase que nao começe com Rua, e nao seja Av. trocar manualmente, tentativas de regex abaixo
# faxinas201819$Endereço <- str_replace(faxinas201819$Endereço , "(^(^Rua$)*)", "Rua ")
# faxinas201819$Endereço <- str_replace(faxinas201819$Endereço, "^(Rua Av.*)", "Av.*")
# faxinas201819$Endereço <- str_replace_all(faxinas201819$Endereço, "(Rua| )*", "Rua ")
# faxinas201819$Endereço <- str_trim(str_to_title(faxinas201819$Endereço))
# str_view(testepalavra, "(^(^Rua\\$))*")
# str_view(testepalavra, "^[^A-Za-z]*[^\\Rua]")
# str_view(testepalavra3, "(Rua|Av)")
```

<!-- #### Depois de padronizado os dados baixei essa planilha para realizar testes -->
```{r,eval = FALSE}
#salvando em csv a planilha modificada 
write_csv(faxinas201819,"dados/faxinas201819.csv")

```

### Observando as 10 primeiras linhas da planilha de faxinas de 2018-2019 
```{r}

# datatable(
#   faxinas201819,
#   colnames = c('ID' = 1),
#   caption = htmltools::tags$caption(
#     style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
#     'Tabela 1: ',
#     htmltools::em('Gerenciamento do Aplicativo entre o período de 2018 a 2019.',)
#   ),
#   editable = 'cell',
#   extensions = c('Buttons'),
#   class = c('cell-border stripe'),
#   options = list(
#     dom = 'Bfrtip',
#     buttons = c('csv', 'excel', 'pdf', 'print', 'colvis')
#   )
# )

#usando os comandos kable e kable_styling para printar as tabelas 

# colunas de 1 a 7
kable(head(faxinas201819[,c(1:7)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 8 a 10
kable(head(faxinas201819[,c(8:10)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# ultima coluna da tabela
kable(head(faxinas201819[,11], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")
```

<!-- #### Planilha de dados das faxinas do Pureco de 2019 a 2020 -->
```{r}
# sheet = 2 le a segunda tabela da planilha salva no arquivo xlsx

faxinas201920 <-
  read_xlsx("dados/[2019-2020]GerenciamentodoAplicativo.xlsx",
    skip = 1,
    sheet = 2,
    col_names = TRUE,
    col_types = c(
      "guess",
      "logical",
      "logical",
      "text",
      "numeric",
      "text",
      "text",
      "text",
      "text",
      "logical",
      "text",
      "numeric",
      "numeric",
      "text",
      "text"
    ),
    range = "B2:P253")

```

<!-- #### Limpeza dos dados -->

```{r}

# transformando as variaveis abaixo para caracteres 
# em cliente e endereço tudo que encontramos como -, --, //, ccc ou rua 
# transformamos para NA(valores faltantes)
# renomeamos a coluna Mulher para Colaborada,
# `Onde foi colhido` para `Onde foi colhido?` de forma a ficar igual a planilha de 2018 e por ultimo
# renomeamos Comentários como comentários gerais nesta planilha
faxinas201920 <- faxinas201920 %>% 
  mutate(`Feedback Colhido?` = as.character(`Feedback Colhido?`),
         Remarcou = as.character(Remarcou), `Ocorreu?` = as.character(`Ocorreu?`)) %>%
  mutate_at(c("Cliente", "Endereço"), 
            funs(ifelse(. == "-" |. == "--" | . == "/" | . == "ccc" | . == "rua", NA, .))) %>%
  rename(`Onde foi colhido?`= `Onde foi colhido`, 
         Colaboradora = Mulher,
         `Comentários gerais` = Comentários)

```

```{r}

# ajustando as datas no formato brasileiro
faxinas201920$Data <- format(faxinas201920$Data, "%d/%m/%Y")
# ajustando as variaveis logicas para sim e nao
faxinas201920[faxinas201920 == "TRUE"] <- "Sim"
faxinas201920[faxinas201920 == "FALSE"] <- "Não"

```

```{r}
# mudanças usando regex e o pacote stringr
faxinas201920$Cliente <- str_trim(str_to_title(faxinas201920$Cliente))
faxinas201920$Endereço <- str_trim(str_to_title(faxinas201920$Endereço))
faxinas201920$`Comentários gerais` <- str_trim(faxinas201920$`Comentários gerais`)
faxinas201920$Endereço <-  str_replace_all(faxinas201920$Endereço, "R\\.", "Rua ")
faxinas201920$Endereço <- str_replace_all(faxinas201920$Endereço, "R ", "Rua ")
faxinas201920$Endereço <- str_replace_all(faxinas201920$Endereço, "^Av.", "Avenida ")
faxinas201920$Endereço <- str_trim(str_to_title(faxinas201920$Endereço))

```

<!-- #### Depois de padronizado os dados baixei essa planilha para realizar testes -->
```{r, eval = FALSE}
#salvando em csv a planilha modificada 
write_csv(faxinas201920,"dados/faxinas201920.csv")
```

### Observando as 10 primeiras linhas da planilha de faxinas de 2019-2020 

```{r}
# depois customizar a tabela com os tamanhos certos "custom table container"
# datatable(
#   faxinas201920,
#   colnames = c('ID' = 1),
#   caption =  htmltools::tags$caption(
#     style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
#     'Tabela 2: ',
#     htmltools::em('Gerenciamento do Aplicativo entre o período de 2019 a 2020.',)
#   ),
#   class = c('cell-border stripe'),
#   extensions = c('Buttons'),
#   options = list(
#     dom = 'Bfrtip',
#     buttons = c('csv', 'excel', 'pdf', 'print', 'colvis')
#   )
# )

# colunas de 1 a 7
kable(head(faxinas201920[,c(1:7)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 8 a 11
kable(head(faxinas201920[,c(8:11)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 12 a 14
kable(head(faxinas201920[,c(12:14)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# ultima coluna da tabela
kable(head(faxinas201920[,15], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")
```

<!-- Planilha mais recente dos dados das faxinas do Pureco de 2020 a 2021 -->
```{r}
# pega as primeiras linhas que conte informações de faxinas indo da posicao da planilha do 
# excel B2 a R9
faxinas202021 <-
  read_xlsx("dados/[PUR][20-21] Gerenciamento do Aplicativo.xlsx",
    skip = 1,
    sheet = 2,
    col_names = TRUE,
    col_types = c(
      "guess",
      "logical",
      "logical",
      "text",
      "numeric",
      "text",
      "text",
      "text",
      "text",
      "text",
      "logical",
      "text",
      "numeric",
      "text",
      "numeric",
      "text",
      "text"
    ),
    range = "B2:R9")
```

```{r}
# transformando algumas variaveis em caracteres e modifcando alguns nomes para ficarem iguais a das planilhas anteriores
faxinas202021 <- faxinas202021 %>% 
  mutate(`Feedback Colhido?` = as.character(`Feedback Colhido?`),
         Remarcou = as.character(Remarcou), `Ocorreu?` = as.character(`Ocorreu?`)) %>%
  rename(`Onde foi colhido?`= `Onde foi colhido`, 
          Valor = `Valor (R$)`) 
```

```{r}
# passando todos os valores logicos true e false para sim e nao 
faxinas202021[faxinas202021 == TRUE] <- "Sim"
faxinas202021[faxinas202021 == FALSE] <- "Não"
# ajustando as datas no formato brasileiro
faxinas202021$Data <- format(faxinas202021$Data, "%d/%m/%Y")
# tirando os espaços entre as palavras 
faxinas202021$`Comentários gerais`<- str_trim(faxinas202021$`Comentários gerais`)
```

```{r, eval = FALSE}
#salvando em csv a planilha modificada 
write_csv(faxinas202021,"dados/faxinas202021.csv")
```

### Observando as 10 primeiras linhas da planilha de faxinas de 2020-2021 
```{r}
# colunas de 1 a 7
kable(head(faxinas202021[,c(1:7)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 8 a 11
kable(head(faxinas202021[,c(8:11)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 12 a 15, menos 14
kable(head(faxinas202021[,c(12:13,15)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# coluna 14 de comentarios do feedback da colaboradora 
kable(head(faxinas202021[,14], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas 15 a 15
kable(head(faxinas202021[,16], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# ultima coluna da tabela
kable(head(faxinas202021[,17], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")
```

<!-- Para juntar faxinas201819 e faxinas201920 tive que mudar alguns nomes de colunas que eram as mesmas mas estavam com nomes diferentes e removi também as colunas duplicadas  -->
```{r}
# passando a coluna feedback cliente para valores numericos e transformandos em nota feedback
faxinas201819$`Feedback cliente` <- as.double(faxinas201819$`Feedback cliente`)

faxinas201819 <- faxinas201819 %>% 
  rename(`Nota feedback cliente` = `Feedback cliente`, 
         `Nota feedback mulher` = `Feedback mulher`) 

# removendo as linhas que ja tem informaçoes de 2019 em faxinas201920
faxinas201819 <- faxinas201819[1:306,] 

```

<!-- Juntando as planilhas de faxina  -->
```{r}
# juntando as planilhas de 2018 a 2020 (março)
faxinas <- full_join(faxinas201819, faxinas201920,
                     by = c("Data", "Colaboradora", "Valor", "Cliente", "Endereço", "Ocorreu?",
                            "Feedback Colhido?", "Onde foi colhido?", "Nota feedback mulher",
                            "Nota feedback cliente", "Comentários gerais")) 
# tirando colunas repetidas 
faxinas <- faxinas %>% distinct()

# juntando com a planilha mais recente (dezembro/janeiro 2021)
faxinas <- full_join(faxinas, faxinas202021,
                     by = c("Data", "Colaboradora", "Valor", "Cliente", "Endereço", "Ocorreu?",
                            "Feedback Colhido?", "Onde foi colhido?", "Nota feedback mulher",
                            "Nota feedback cliente", "Comentários gerais", "Remarcou",
                            "Feedback cliente","Região", "Tipo"))

```


```{r, eval=FALSE}
#salvando em csv a planilha com todas as faxinas para utilizar no site
write_csv(faxinas, "../www/faxinas.csv")
```

### Observando as 10 primeiras linhas da planilha de faxinas juntas de 2018 a 2021 
```{r}
# datatable(
#   faxinas,
#   colnames = c('ID' = 1),
#   caption =  htmltools::tags$caption(
#     style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
#     'Tabela 3: ',
#     htmltools::em('Gerenciamento do Aplicativo entre o período de 2018 a 2020.',)
#   ),
#   class = c('cell-border stripe'),
#   extensions = c('Buttons'),
#   options = list(
#     dom = 'Bfrtip',
#     buttons = c('csv', 'excel', 'pdf', 'print', 'colvis')
#   )
# )

# colunas de 1 a 7
kable(head(faxinas[,c(1:7)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 8 a 14, menos a 11
kable(head(faxinas[,c(8,9,10,12,13, 14)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")


# coluna comentarios
kable(head(faxinas[,11], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

# colunas de 15 a 17
kable(head(faxinas[,c(15:17)], 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "center", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")

```

### Planilha de disponibilidade

<!-- Juntei a planilha de disponibilidade da Marília com a de calendário de dias disponíveis de 2019/2020  -->

```{r}
# lendo a planilha de disponibilidade passada pela marilia
disponibilidade201819 <-read_csv2("dados/disponibilidade201819.csv", col_names = TRUE)

```

```{r}
# lendo a planilha de disponibilidade criada por mim olhando o calendário da planilha 
# e seguindo o formato da anterior 
disponibilidade201920 <-read_csv("dados/disponibilidade201920.csv", col_names = TRUE)
```
 
<!-- Seria interessante no futuro deixar como sim ou nao se tem disponobilidade inves de por 2 que é a quantidade de horarios que tem para faxinas por dia -->
```{r}
# lendo a planilha de disponibilidade criada por mim olhando o calendário da planilha 
# de 2021 mais recente e seguindo os formatos da anteriores
disponibilidade2021 <-read_csv("dados/disponibilidade2021.csv", col_names = TRUE)

``` 

```{r}
# juntando as planilhas de disponibilidade 
disponibilidade <- full_join(disponibilidade201819, disponibilidade201920, 
                             by = c("Mulher", "Disponibilidade", "Data"))  %>% 
  rename(Colaboradora = Mulher)

# juntando a planilha mais recente de 2021
disponibilidade  <- full_join(disponibilidade, disponibilidade2021, 
                             by = c("Colaboradora", "Disponibilidade", "Data"))

# 10 primeiras linhas da planilha
kable(head(disponibilidade, 10), digits = 2, align = 'c') %>% 
  kableExtra::kable_styling(full_width = TRUE, position = "left", 
                            font_size = 10,row_label_position = "l", 
                            html_font = "helvetica")
```

```{r, eval=FALSE}
#salvando em csv a planilha modificada 
write_csv(disponibilidade,"../www/disponibilidade.csv")
```

<!-- ### Informações faxineiras e ### Informações Clientes -->
<!-- Estas planilhas nao foram utilizadas pois contem uma formatacao muito ruim para conseguir extrair os dados, mas a maioria destas informaçãoes contam em faxinas -->


