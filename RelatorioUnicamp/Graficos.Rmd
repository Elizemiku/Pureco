---
title: "Gráficos PURECO"
author: "Elizabeth Borgognoni Souto"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
runtime: shiny
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow', dplyr.summarise.inform = FALSE)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

```{r}
library("tidyverse")
library("plotly")
library("knitr")
library("lubridate")
```

```{r code = readLines("../Temas.R") }

```

```{r, results='hide'}
knit_child('Relatoriotecnicodados.Rmd')
```

```{r}

faxinas$Data <-
  as.POSIXct(faxinas$Data, "UTC", format = "%d/%m/%Y")

faxinas$`Dia da Semana` <- wday(faxinas$Data, label = TRUE, abbr = FALSE)

```

## Quantidade de Faxinas por Dias da Semana

```{r}
renderPlotly({
        
        # quantidade totais de faxinas feitas pelo pureco de todos os anos
        # colocar facets por ano 
        g1 <- faxinas %>% filter(Mulher != "NA" & `Dia da Semana` != is.na(NA)) %>% 
          mutate(Quantidade = 1) %>%
          group_by(`Dia da Semana`)  %>% 
          summarize(Quantidade = sum(Quantidade)) %>%
          ggplot(aes(x = `Dia da Semana`, 
                     y = Quantidade, 
                     fill = `Dia da Semana`)) +
          geom_bar(stat = "identity", position = "stack") + 
          ggtitle("Quantidade de Faxinas por Dia da Semana") +
          ylab("Quantidade de Faxinas") + tema_geral + 
          theme(axis.text.x =  element_blank(),
                axis.title.x = element_blank()) +
          scale_fill_viridis_d()

        g1 <- ggplotly(g1, tooltip = c("x", "y"))

        g1
        
      })
```

```{r}
renderPlotly({
# Gráfico de Faxinas por dia da semana
# valor acumulado ao longo do periodo inserido para análise
# boxplot que faz parecido tentar o mesmo aqui stat_summary(
b1 <- ggplot(faxinas %>% filter(Mulher != "NA") %>% mutate(Quantidade = 1) %>%
         group_by(`Dia da Semana`) %>% select(`Dia da Semana`, Quantidade) %>%
         mutate(Quantidade = cumsum(Quantidade)),
       aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  geom_boxplot() + ggtitle("Quantidade de Faxinas por Dia da Semana") + 
  ylab("Quantidade de Faxinas") + tema_geral + 
  theme(axis.text.x =  element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_viridis_d()

 b1 <- ggplotly(b1, tooltip = c("x", "y"))
  
 b1
})  
```

```{r}
renderPlotly({
        # Gráfico de Faxinas por dia Tipo e dia da semana
        # valor acumulado ao longo do periodo inserido para análise
        
        g2 <- ggplot(faxinas %>% mutate(Quantidade = 1) %>%
                       filter(Tipo != "NA" & `Ocorreu?` == "Sim" & `Dia da Semana` != is.na(NA)),
                     aes(
                       x = `Dia da Semana`,
                       y = Quantidade,
                       fill = `Dia da Semana`
                     )) +
          stat_summary(fun = "sum", geom = "bar") + 
          ggtitle("Quantidade de Faxinas por Tipo de faxina e Dia da Semana") +
          ylab("Quantidade de Faxinas") + 
          theme(axis.text.x =  element_blank(),
                axis.title.x = element_blank(),
                strip.background = element_rect(colour = "black", fill = "#99CCFF")) +
          tema_geral + 
          scale_fill_viridis_d()
        
        g2 <- g2 + facet_wrap(~Tipo) 
        
        g2 <- ggplotly(g2, tooltip = c("x", "y"))
        
        g2
})        
```

```{r}
renderPlotly({
        
        m2 <- ggplot(
          faxinas %>% mutate(Quantidade = 1) %>%
            filter(Mulher != "NA" & Mulher != "Maria" & `Ocorreu?` == "Sim"
                   & `Dia da Semana` != is.na(NA)),
          aes(
            x = `Dia da Semana`,
            y = Quantidade,
            fill = `Dia da Semana`
          )
        ) +
          stat_summary(fun = "sum", geom = "bar") +
          facet_wrap( ~ Mulher, scales = "free_x") +
          ggtitle("Quantidade de Faxinas por Mulher e Dia da Semana") +
          ylab("Quantidade de faxinas") +
          theme(
            axis.text.x =  element_blank(),
            axis.line = element_line(colour = "black"),
            panel.background = element_rect(fill = "white", size = 2),
            panel.grid.major = element_line(
              colour = "gray",
              size = 1,
              linetype = "solid"
            ),
            panel.grid.minor = element_line(
              colour = "gray",
              size = 1,
              linetype = "solid"
            ),
            strip.background = element_rect(colour = "black", fill = "#99CCFF") 
          ) + scale_fill_viridis_d() + scale_x_discrete(expand = c(0, 0))
        
        m2 <- ggplotly(m2, tooltip = c("x", "y"))
        
        m2
        
      })
```


## Quantidade de faxinas por Mulher
```{r}
 renderPlotly({
        
        m1 <- ggplot(faxinas %>% mutate(Quantidade = 1) %>%
                       filter(Mulher != "NA" & Mulher != "Maria" & 
                                `Ocorreu?` == "Sim"),
                     aes(x = Mulher,y = Quantidade,fill = Mulher)) +
          stat_summary(fun = "sum", geom = "bar") +
          ggtitle("Quantidade de Faxinas por Mulher") +
          ylab("Quantidade de faxinas") +
          theme(
            legend.position = 'none',
            axis.line = element_line(colour = "black"),
            panel.background = element_rect(fill = "white", size = 2),
            panel.grid.major = element_line(
              colour = "gray",
              size = 1,
              linetype = "solid"
            ),
            panel.grid.minor = element_line(
              colour = "gray",
              size = 1,
              linetype = "solid"
            )
          ) + scale_fill_viridis_d()
        
        m1 <- ggplotly(m1, tooltip = c("x", "y"))
        
        m1
        
      })
```


## Quantidade de faxinas totais

```{r}
faxinas2 <- faxinas %>% filter(`Ocorreu?` == "Sim") %>%
          mutate(fax = 1)
        
        x <- data.frame(Data = seq.POSIXt(from = min(faxinas2$Data),
                                          to = max(faxinas2$Data),
                                          by = "day"),QTDE = 0)
        
        faxinas2 <- full_join(faxinas2, x, by = c("Data"))
        faxinas2 <- faxinas2 %>% select(-QTDE)
        faxinas2$fax[is.na(faxinas2$fax)] <- 0
        
        faxinas2 <- faxinas2  %>% 
          mutate(`Mês` = month(Data, label = TRUE, abbr = FALSE), 
                 ano = year(Data)) %>%
          group_by(ano,`Mês`) %>%
          summarize(Quantidade = sum(fax)) %>% 
          mutate(Quantidade = as.integer(Quantidade)) %>%
          select(`Mês`, Quantidade, ano ) 
```

### Separadas por ano com gráfico de barras 

```{r}
renderPlotly({
faxinas2_ano2018 <- ggplot(faxinas2 %>% filter(ano == "2018"),
                           aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2018") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas totais realizadas") +
  scale_fill_viridis_d()

faxinas2_ano2019 <- ggplot(faxinas2 %>% filter(ano == "2019"),
                           aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2019") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas totais realizadas") +
  scale_fill_viridis_d()

faxinas2_ano2020 <- ggplot(faxinas2 %>% filter(ano == "2020"),
                           aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2020") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas totais realizadas") +
  scale_fill_viridis_d()

faxinas2_ano2018 <- faxinas2_ano2018  + tema_faxinas2
faxinas2_ano2019 <- faxinas2_ano2019  + tema_faxinas2
faxinas2_ano2020 <- faxinas2_ano2020  + tema_faxinas2

faxinas2_ano2018 <- ggplotly(faxinas2_ano2018, tooltip = c("x", "y"))
faxinas2_ano2019 <- ggplotly(faxinas2_ano2019, tooltip = c("x", "y"))
faxinas2_ano2020 <- ggplotly(faxinas2_ano2020, tooltip = c("x", "y"))

subplot(faxinas2_ano2018, faxinas2_ano2019, faxinas2_ano2020, 
       titleX = TRUE)

})

```

### Usando facet grid com gráfico de linhas
```{r}
renderPlotly({
f2 <- ggplot(faxinas2, aes(x=`Mês`, y = Quantidade, group = 1)) +
         geom_line(col = "blue") +
         facet_grid(~ano) + ggtitle("Quantidade de Faxinas por Ano") +
         ylab("Quantidades de faxinas por mês") + tema_faxinas2 +
         theme(strip.background = element_rect(colour = "black", fill = "#99CCFF"),
               axis.title.x = element_blank())

       f2 <- ggplotly(f2, tooltip = c("x", "y"))

       f2
})
```


