---
title: "Gráficos PURECO"
author: "Elizabeth Borgognoni Souto"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    smooth_scroll: true
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow', dplyr.summarise.inform = FALSE)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

```{r, include=FALSE}
library("tidyverse")
library("plotly")
library("knitr")
library("lubridate")
library("flexdashboard")
library("shiny")
library("quantmod")
library("scales")
library("zoo")
```

```{r code = readLines("../Temas.R") , echo = FALSE}

```

```{r, results='hide', echo = FALSE}
knit_child('Relatoriotecnicodados.Rmd')
```

```{r, echo = FALSE}

faxinas$Data <-
  as.POSIXct(faxinas$Data, "UTC", format = "%d/%m/%Y")

faxinas$`Dia da Semana` <- wday(faxinas$Data, label = TRUE, abbr = TRUE)

disponibilidade$Data <-  as.POSIXct(disponibilidade$Data, "UTC", format = "%d/%m/%Y")

```

Quantidade de Faxinas por Dias da Semana 
=====================================  

Row
---------------------------------------------------------


### Barplot Quantidade entre os anos 
```{r}
renderPlotly({
  
g1 <- faxinas %>% 
  filter(Mulher != "NA" & `Dia da Semana` != is.na(NA)) %>% 
  mutate(Quantidade = 1) %>%
  group_by(`Dia da Semana`)  %>% 
  summarize(Quantidade = sum(Quantidade)) %>%
  ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  geom_bar(stat = "identity", position = "stack") + 
  ylab("Quantidade de Faxinas") + 
  ggtitle("Quantidade de Faxinas por Dia da Semana") +
  tema_geral + 
  scale_fill_viridis_d()

  g1 <- ggplotly(g1, tooltip = c("x", "y"))

  g1
})
```

### Barplot Quantidade Por ano 
```{r}
renderPlotly({
  
# so acrescentei a variavel ano 
g1a <- faxinas %>% 
  filter(Mulher != "NA" & `Dia da Semana` != is.na(NA)) %>%
  mutate(Quantidade = 1, ano = year(Data)) %>%
  group_by(`Dia da Semana`,ano)  %>% 
  summarize(Quantidade = sum(Quantidade)) %>%
  ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  geom_bar(stat = "identity", position = "stack") + 
  facet_grid(~ano) +
  ylab("Quantidade de Faxinas por Dia da Semana") + 
  ggtitle("Quantidade de Faxinas por Ano") +
  tema_facets + 
  scale_fill_viridis_d()
        
 g1a <- ggplotly(g1a, tooltip = c("x", "y"))

 g1a
})
```

Row
---------------------------------------------------------

### Boxplot Quantidade entre os anos
```{r}
renderPlotly({
# Gráfico de Faxinas por dia da semana
# valor acumulado ao longo do periodo inserido para análise
b1 <- faxinas %>% 
  filter(Mulher != "NA") %>% mutate(Quantidade = 1) %>%
  group_by(`Dia da Semana`) %>%
  mutate(Quantidade = cumsum(Quantidade)) %>%
  ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  geom_boxplot() + 
  ylab("Quantidade de Faxinas") + 
  ggtitle("Quantidade de Faxinas por Dia da Semana") + 
  tema_geral +
  scale_fill_viridis_d()

 b1 <- ggplotly(b1, tooltip = c("x", "y"))
  
 b1
})  
```

### Boxplot Quantidade Por ano 
```{r}
## rever esse grafico
renderPlotly({

b1a <-faxinas %>% 
    filter(Mulher != "NA") %>% mutate(Quantidade = 1, ano = year(Data)) %>%
    group_by(`Dia da Semana`, ano) %>%
    mutate(Quantidade = cumsum(Quantidade)) %>%
    ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
    geom_boxplot() + facet_grid(~ano) +
    ylab("Quantidade de Faxinas") + 
    ggtitle("Quantidade de Faxinas por Ano") + 
    tema_facets +
    scale_fill_viridis_d()

 b1a <- ggplotly(b1a, tooltip = c("x", "y", "fill"))

 b1a

})
```

### Por Tipo 
```{r}
renderPlotly({

# Gráfico de Faxinas por dia Tipo e dia da semana
# valor acumulado ao longo do periodo inserido para análise
        
g2 <- faxinas %>% 
  filter(Tipo != "NA" & `Ocorreu?` == "Sim" & `Dia da Semana` != is.na(NA)) %>%
  mutate(Quantidade = 1) %>%
  ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  stat_summary(fun = "sum", geom = "bar") + 
  facet_wrap(~Tipo) + 
  ylab("Quantidade de Faxinas") + 
  ggtitle("Quantidade de Faxinas por Tipo de faxina e Dia da Semana") +
  tema_facets + 
  scale_fill_viridis_d()
        
  g2 <- ggplotly(g2, tooltip = c("x", "y"))
        
  g2
})        
```



Quantidade de faxinas por Mulher
=====================================  

Row{.tabset}
-------------------------------------


### Quantidade de faxinas totais por Mulher

```{r}
renderPlotly({
        
m1 <- faxinas %>% 
  filter(Mulher != "NA" & Mulher != "Maria" & `Ocorreu?` == "Sim") %>%
  mutate(Quantidade = 1) %>%
  ggplot(aes(x = Mulher,y = Quantidade,fill = Mulher)) +
  stat_summary(fun = "sum", geom = "bar") +
  ylab("Quantidade de faxinas") +
  ggtitle("Quantidade de Faxinas por Mulher") +
  tema_geral + 
  scale_fill_viridis_d()
        
  m1 <- ggplotly(m1, tooltip = c("x", "y"))
        
  m1
})
```


### Quantidade de faxinas por Mulher e ano 
```{r}
renderPlotly({
        
m1 <- faxinas %>% 
  filter(Mulher != "NA" & Mulher != "Maria" & `Ocorreu?` == "Sim") %>%
  mutate(Quantidade = 1, ano = year(Data)) %>%
  ggplot(aes(x = Mulher,y = Quantidade,fill = Mulher)) +
  stat_summary(fun = "sum", geom = "bar") + facet_grid(~ano) +
  ylab("Quantidade de faxinas") +
  ggtitle("Quantidade de Faxinas por Mulher") +
  tema_facets +
  scale_fill_viridis_d()
        
  m1 <- ggplotly(m1, tooltip = c("x", "y"))
        
  m1
})
```

### Quantidade de faxinas por Mulher e dias da semanas 
```{r}
renderPlotly({
        
m2 <- faxinas %>% 
  filter(Mulher != "NA" & Mulher != "Maria" & 
           `Ocorreu?` == "Sim" & `Dia da Semana` != is.na(NA)) %>%
  mutate(Quantidade = 1) %>% 
  ggplot(aes(x = `Dia da Semana`, y = Quantidade, fill = `Dia da Semana`)) +
  stat_summary(fun = "sum", geom = "bar") +
  facet_wrap( ~ Mulher, scales = "free_x") +
  ylab("Quantidade de faxinas") +
  ggtitle("Quantidade de Faxinas por Mulher e Dia da Semana") +
  tema_facets + 
  scale_fill_viridis_d() + 
  scale_x_discrete(expand = c(0, 0))
        
  m2 <- ggplotly(m2, tooltip = c("x", "y"))
    
  m2
})
```

Page with Tabset {.tabset .tabset-fade}
-------------------------------------

```{r}
faxinas2 <- faxinas %>% filter(`Ocorreu?` == "Sim") %>%
          mutate(fax = 1)
        
x <- data.frame(Data = seq.POSIXt(from = min(faxinas2$Data),
                                          to = max(faxinas2$Data),
                                          by = "day"),QTDE = 0)
        
faxinas2 <- full_join(faxinas2, x, by = c("Data"))
faxinas2 <- faxinas2 %>% select(-QTDE)
faxinas2$fax[is.na(faxinas2$fax)] <- 0
        
faxinas2 <- faxinas2  %>% 
  mutate(`Mês` = month(Data, label = TRUE, abbr = TRUE), ano = year(Data)) %>%
  group_by(ano,`Mês`) %>%
  summarize(Quantidade = sum(fax)) %>% 
  mutate(Quantidade = as.integer(Quantidade)) %>%
  select(`Mês`, Quantidade, ano ) 
```

### Separadas por ano com gráfico de barras {data-width=500}

```{r}
renderPlotly({
  
faxinas2_ano2018 <- faxinas2 %>% 
  filter(ano == "2018") %>%
  ggplot(aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2018") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas Totais") +
  scale_fill_viridis_d()

faxinas2_ano2019 <- faxinas2 %>% 
  filter(ano == "2019") %>%
  ggplot(aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2019") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas totais realizadas") +
  scale_fill_viridis_d()

faxinas2_ano2020 <- faxinas2 %>% 
  filter(ano == "2020") %>%
  ggplot(aes(x = `Mês`, y = Quantidade, fill = `Mês`)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Meses-2020") + ylab("Número de Faxinas") +
  ggtitle("Quantidade de faxinas totais realizadas") +
  scale_fill_viridis_d()

faxinas2_ano2018 <- faxinas2_ano2018  + tema_faxinas2
faxinas2_ano2019 <- faxinas2_ano2019  + tema_faxinas2
faxinas2_ano2020 <- faxinas2_ano2020  + tema_faxinas2

faxinas2_ano2018 <- ggplotly(faxinas2_ano2018, tooltip = c("x", "y"))
faxinas2_ano2019 <- ggplotly(faxinas2_ano2019, tooltip = c("x", "y"))
faxinas2_ano2020 <- ggplotly(faxinas2_ano2020, tooltip = c("x", "y"))

subplot(faxinas2_ano2018, faxinas2_ano2019, faxinas2_ano2020, titleX = TRUE)

})

```

### Usando facet grid com gráfico de linhas {data-width=500}

```{r}
renderPlotly({
  
f2 <- faxinas2 %>% 
  ggplot(aes(x=`Mês`, y = Quantidade, group = 1)) +
  geom_line(col = "blue") +
  facet_grid(~ano) +
  ylab("Quantidades de faxinas por mês") + 
  ggtitle("Quantidade de Faxinas Totais por Ano") +
  tema_facets +
  theme(axis.text.x = element_text(angle = 20))

  f2 <- ggplotly(f2, tooltip = c("x", "y"))
  
  f2
})
```


Calendário
=====================================  

```{r}


renderPlotly({
library('plyr')
disponibilidade2 <- fortify.zoo(disponibilidade)

disponibilidade2 <- disponibilidade2 %>% 
  filter(Disponibilidade != "NA") %>%
  mutate(ano = year(Data), mes = month(Data, label = TRUE),
         dia= day(Data),
         Semana = as.numeric(format(Data, "%W")),
         `Dia da Semana` = wday(Data, label=TRUE, abbr = FALSE,
                                getOption("lubridate.week.start", 7))) 
  
  
# disponibilidade2 <- ddply(disponibilidade2,
#                           .(mesano),transform,semanadomes=1+Semana-min(Semana))  

  d1 <- ggplot(disponibilidade2, aes(x = Semana, y = `Dia da Semana`)) + 
  geom_tile(aes(fill = Mulher)) + 
  facet_grid(ano~mes, scales="free", space="free") + 
  ggtitle("Calendário de Disponibilidade") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank(),
        strip.background = element_rect(colour = "black", fill = "#99CCFF"))
  
  d1 <- ggplotly(d1)
        
  d1

})
```

Faxinas em geral 
=====================================  

Row{.tabset}
------------------------------------------------------------

### Número médio de Faxinas

```{r}
# ## numero medio de faxinas por todos os dias das semana, semana de domingo a sabado
# renderPlotly({
# n1 <- faxinas %>% 
#   mutate(Quantidade = 1, ano = year(Data), semanas = week(Data)) %>% 
#   filter(Mulher != "NA" & `Dia da Semana` != is.na(NA)) %>% 
#   group_by(ano, `Dia da Semana`) %>% summarize(Quantidade = sum(Quantidade)) %>% 
#   ggplot(aes(x = ano, y = Quantidade)) + 
#   stat_summary(fun = mean , geom = "bar") +
#    ggtitle("Número médio de faxinas por Semana") +
#           ylab("Quantidade") +
#           theme(
#             legend.position = 'none',
#             axis.line = element_line(colour = "black"),
#             panel.background = element_rect(fill = "white", size = 2),
#             panel.grid.major = element_line(
#               colour = "gray",
#               size = 1,
#               linetype = "solid"
#             ),
#             panel.grid.minor = element_line(
#               colour = "gray",
#               size = 1,
#               linetype = "solid"
#             )
#           )
# 
# n1 <- ggplotly(n1, tooltip = c("x", "y"))
# 
# n1
# })

```

### Feedback Faxinas

```{r}
renderPlotly({
fe1 <- faxinas %>% 
  filter(`Ocorreu?` != "NA" & `Ocorreu?`=="Sim" & 
               `Nota feedback cliente` != "NA" & Mulher != "NA") %>% 
  mutate(ano = year(Data)) %>% 
  ggplot(aes( x=`Nota feedback cliente`, fill = Mulher,                                         group = interaction(`Nota feedback cliente`, Mulher))) +
  geom_bar() + 
  facet_grid(~ano) +
  ylab("Quantidade de feedbacks") +
  ggtitle("Nota de feedback dos clientes por Mulher e Ano") +
  tema_facets + 
  theme(axis.text.x = element_text(size = 8)) 
  
  fe1 <- ggplotly(fe1, tooltip = c("x", "y"))

  fe1
})
```

### Informação sobre as faxinas que não ocorreram 

```{r}
renderPlotly({
  
f1 <- faxinas %>% 
  filter(`Ocorreu?` != "NA" & `Ocorreu?`=="Não" & 
             Remarcou != "NA" & Mulher != "NA") %>% 
  mutate(ano = year(Data)) %>%
  ggplot(aes(x= Remarcou, fill = Mulher)) +
  geom_bar() + 
  facet_grid(~ano) +
  ylab("Número de faxinas que não ocorreram") +
  ggtitle("Número de faxinas remarcadas por Ano e por Mulher") +
  tema_facets 

  f1 <- ggplotly(f1, tooltip = c("x", "y"))

  f1  
})
```


