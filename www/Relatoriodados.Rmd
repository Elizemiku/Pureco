---
title: "Relatório de dados do Pureco"
date: "26/05/2020"
output: 
  flexdashboard::flex_dashboard:
    theme: cosmo
    storyboard: true
---
<!--argumento para deixar a página mais centralizada-->
<style>
body {
    position: center;
    left: 0px;}
</style>

### Trabalhando com os dados: Descrição dos dados, comentários sobre formas de padronização e sobre as  planilhas coletadas pelo aplicativo.

```{r, echo = FALSE, message=FALSE, warning=FALSE}
# carregando pacotes para manipulação das planilhas
library("stringr")
library("tidyverse")
library("janitor")
library("readxl")
library("DT")
library("rebus")
library("flexdashboard")
options(DT.options = list(pageLength = 5))
```

Leitura das planilhas e limpeza dos dados 

- | Na parte de limpeza dos dados, foram removidas todas as colunas vazias ou que continham números sem sentido, as planilhas estão separadas pois diferem em muitos aspectos. Os valores: 0 ou 1, true ou false, foram transformados para sim ou não.

Ideias para melhorar as planilhas: 

- | Nas colunas: **Feedback cliente** e **Feedback mulher** evitar colocar os dados como : **2,5 ~ 3,0** pois não é possível trabalhar com a análise nesse formato de nota, nesse caso, por exemplo, poderíam fazer uma média entre esses valores;

- | Na última coluna da planilha mais antiga, observa-se apenas as colunas **Ocorreu?** e **Feedback Colhido?** preenchidas, nesse caso não sei se esses dados são verídicos ou se alguém esqueceu de preencher as informações das outras colunas;

- | A variável **Onde foi colhido?** tem poucos dados preenchidos nas duas planilhas;

- | Nas duas planilhas há valores com apenas o número e valores com R$ na frente do número, seria melhor escolher apenas um para representar na tabela;

- | Nas duas planilhas os endereços começam por R.,R, rua, Rua, ou não começam com Rua e há somente o restante do nome do endereço. Seria bom padronizar nesse caso também para todos que são Rua ou Avenida começarem com Rua e Avenida, por exemplo.

Ideias de análises e gráficos:

- | Quantidade de faxinas por dia da semana - OK 
- | Mapas, acrescentar latitude e longitude de acordo com os endereços (*ver pacote rselenion*)
- | Porcentagem de faxinas que não ocorreram, que foram remarcadas ou não.
- | Gráfico do valor ganho com as faxinas por mês para cada faxineira.
- | Análise dos comentários positivos. 

<!-- #### Planilha de dados das faxinas do Pureco de 2018 a 2019 -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
faxinas201819 <- read_xlsx("/home/elizemiku/Documents/PURECO-BAS/[2018-2019]GerenciamentodoAplicativo.xlsx", skip = 1, col_names = TRUE)
```

<!-- #### Limpeza dos dados -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
# as.POSIXct(faxinas$Data, "UTC", format="%d/%m/%Y")

faxinas201819 <- faxinas201819 %>%
  mutate(Data = as.numeric(Data), `Ocorreu?` = as.logical(`Ocorreu?`)) %>%
  mutate(Data = convert_to_date(Data)) %>%
  mutate(Valor = as.numeric(Valor),
    `Ocorreu?` = as.character(`Ocorreu?`),
    `Feedback Colhido?` = as.character(`Feedback Colhido?`)
  ) %>%
  mutate_at(c("Cliente", "Endereço"), 
            funs(ifelse(. == "-" |. == "--" | . == "/" | . == "ccc" | . == "rua", NA, .))) %>%
  select(c(1:11)) %>% rename(Comentarios = "...11") %>%
  remove_empty("rows")

```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
faxinas201819[faxinas201819 == TRUE] <- "Sim"
faxinas201819[faxinas201819 == FALSE] <- "Não"
faxinas201819$Data <- format(faxinas201819$Data, "%d/%m/%Y")
faxinas201819$Valor <- formatC(faxinas201819$Valor, format = "f", digits = 2, big.mark = ",")
```

```{r,  echo = FALSE, message=FALSE, warning=FALSE}

faxinas201819$Cliente <- str_trim(str_to_title(faxinas201819$Cliente))
faxinas201819$Comentarios <- str_trim(faxinas201819$Comentarios)
faxinas201819$Endereço <-  str_replace_all(faxinas201819$Endereço, "R\\.", "Rua ")
faxinas201819$Endereço <- str_replace_all(faxinas201819$Endereço, "R ", "Rua ")
# modificar Av. , Av para Avenida
faxinas201819$Endereço <- str_trim(str_to_title(faxinas201819$Endereço))


#nao consegui fazer encontrar um caractere antes de qualquer frase que nao começe com Rua, e nao seja Av. trocar manualmente 
# faxinas201819$Endereço <- str_replace(faxinas201819$Endereço , "(^(^Rua$)*)", "Rua ")
# faxinas201819$Endereço <- str_replace(faxinas201819$Endereço, "^(Rua Av.*)", "Av.*")
# faxinas201819$Endereço <- str_replace_all(faxinas201819$Endereço, "(Rua| )*", "Rua ")
# faxinas201819$Endereço <- str_trim(str_to_title(faxinas201819$Endereço))
# str_view(testepalavra, "(^(^Rua\\$))*")
# str_view(testepalavra, "^[^A-Za-z]*[^\\Rua]")
# str_view(testepalavra3, "(Rua|Av)")
```

<!-- #### Depois de padronizado os dados baixei essa planilha para realizar testes -->
```{r, echo = FALSE, eval = FALSE}
write_csv(faxinas201819, "/home/elizemiku/Documents/PURECO-BAS/Pureco/faxinas201819.csv")
```

### Planilha 1 : 
```{r, echo = FALSE}
# depois customizar a tabela com os tamanhos certos "custom table container"
# posso usar essa opcao de edicao para mudar coisas mais rápidas talvez
# adicionar show number of pags
datatable(
  faxinas201819,
  colnames = c('ID' = 1),
  caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
    'Tabela 1: ',
    htmltools::em('Gerenciamento do Aplicativo entre o período de 2018 a 2019.',)
  ),
  editable = 'cell',
  style = 'bootstrap',
  extensions = c('Buttons'),
  class = c('table-bordered', 'cell-border', 'compact'),
  options = list(
    dom = 'Bfrtip',
    buttons = c('csv', 'excel', 'pdf', 'print', 'colvis')
  )
)

```

<!-- #### Planilha de dados das faxinas do Pureco de 2019 a 2020 -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
faxinas201920 <- read_xlsx("/home/elizemiku/Documents/PURECO-BAS/[2019-2020]GerenciamentodoAplicativo.xlsx", sheet = 2, skip = 1, col_names = TRUE)
```

<!-- #### Limpeza dos dados -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
faxinas201920 <- faxinas201920 %>% 
  mutate(`Feedback Colhido?` = as.logical(`Feedback Colhido?`),
         Remarcou = as.logical(Remarcou), Valor = as.numeric(Valor)) %>%
  mutate(`Feedback Colhido?` = as.character(`Feedback Colhido?`),
         Remarcou = as.character(Remarcou)) %>%
  mutate_at(c("Cliente", "Endereço"), 
            funs(ifelse(. == "-" |. == "--" | . == "/" | . == "ccc" | . == "rua", NA, .))) %>%
  remove_empty("rows") %>% select(-1)
```


```{r, echo = FALSE, message=FALSE, warning=FALSE}
faxinas201920$Data <- format(faxinas201920$Data, "%d/%m/%Y")
faxinas201920$`Ocorreu?`[faxinas201920$`Ocorreu?` == "1.0"] <- "Sim"
faxinas201920$`Ocorreu?`[faxinas201920$`Ocorreu?` == "0.0"] <- "Não"
faxinas201920[faxinas201920 == "TRUE"] <- "Sim"
faxinas201920[faxinas201920 == "FALSE"] <- "Não"
faxinas201920$Valor <- formatC(faxinas201920$Valor, format = "f", digits = 2,  big.mark = ",")
```


```{r, echo = FALSE, message=FALSE, warning=FALSE}
#removendo as ultimas linha que so contem NA  
faxinas201920 <- faxinas201920 %>%  filter(Data != "NA")

# mudar ocorreu pra sim e nao usando regex
faxinas201920$Cliente <- str_trim(str_to_title(faxinas201920$Cliente))
faxinas201920$Endereço <- str_trim(str_to_title(faxinas201920$Endereço))
faxinas201920$Comentários <- str_trim(faxinas201920$Comentários)
faxinas201920$Endereço <-  str_replace_all(faxinas201920$Endereço, "R\\.", "Rua ")
faxinas201920$Endereço <- str_replace_all(faxinas201920$Endereço, "R ", "Rua ")
faxinas201920$Endereço <- str_trim(str_to_title(faxinas201920$Endereço))

```

<!-- #### Depois de padronizado os dados baixei essa planilha para realizar testes -->
```{r, echo = FALSE, eval = FALSE}
write_csv(faxinas201920, "/home/elizemiku/Documents/PURECO-BAS/Pureco/faxinas201920.csv")
```

### Planilha 2: 
```{r, echo = FALSE}
# depois customizar a tabela com os tamanhos certos "custom table container"
datatable(
  faxinas201920,
  colnames = c('ID' = 1),
  caption =  htmltools::tags$caption(
    style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
    'Tabela 2: ',
    htmltools::em('Gerenciamento do Aplicativo entre o período de 2019 a 2020.',)
  ),
  class = c('table-bordered', 'cell-border', 'compact'),
  style = 'bootstrap',
  extensions = c('Buttons'),
  options = list(
    dom = 'Bfrtip',
    buttons = c('csv', 'excel', 'pdf', 'print', 'colvis')
  )
)
```

###


